<%- include('header', { showSplash }) %>

<%- include('components/tabs') %>
<button onclick="enablePush()">Enable Notification</button>

<script>
const publicKey =
  "BJWe8UVMdh575cYA75oB1F3cXfNDg8ahcaL4Q2kP8b2GOR0P2OU1uW-LiIAm4M39BpN1k2PkfaRsf19-2nUbCM8";

async function enablePush() {

  // 1Ô∏è‚É£ Support check
  if (!("serviceWorker" in navigator)) {
    alert("Service Worker not supported");
    return;
  }
  if (!("PushManager" in window)) {
    alert("Push not supported");
   // return;
  }
  

  // 2Ô∏è‚É£ Register SW
  const registration = await navigator.serviceWorker.register("/sw.js");
  await navigator.serviceWorker.ready;
  console.log("SW ready");

  // üî• 3Ô∏è‚É£ IMPORTANT: remove old subscription
  const existingSub = await registration.pushManager.getSubscription();
  console.log("exit", existingSub)
  if (existingSub) {
    console.log("Old subscription found ‚Üí removing");
    await existingSub.unsubscribe();
  }

  // 4Ô∏è‚É£ Fresh subscribe
 const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(publicKey)
  });

  console.log("Subscribed successfully", subscription); 

  // 5Ô∏è‚É£ Send to server
  await fetch("/subscribe", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(subscription)
  });

  alert("Notifications enabled ‚úÖ");
 
 }

// helper
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, "+")
    .replace(/_/g, "/");

  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

console.log("cc", urlBase64ToUint8Array(publicKey))
</script>

<!-- =======================
     Node Info & Status
======================= -->
<p><%= nodeVersion %></p>

<%- include('components/category') %>
<%- include('components/PostList') %>


<%- include('footer') %>